---
title: "Figure 2"
author: "Huaying Qiu"
date: "2024-12-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This Rmd include the code to reproduce the plots related to proteomics data in figure 2. <ins>**Note that for most chunks `eval = FALSE`**</ins>. If one wish to knit the Rmd, instead of running the chunks one by one, one should set `eval = TRUE`.

# Packages

```{r, message=FALSE, warning=FALSE}

library(tidyverse)
library(ComplexHeatmap)
library(matrixStats)

```

# Load and Process Data

## Annotation

Mainly three columns from these dataset were used:

- `coreName`: Identifier of tissue sample.
- `cellLabel`: Unique cell ID generated by the segmentation.
- `Annotation`: Cell type annotation.  

These data frames served as the bases which the functional markers were later joined to. 

```{r, message=FALSE, warning=FALSE, eval=TRUE}

L24_annotation <- read_csv('~/INDEPTH/run_031124/L24_final_annotation.csv')
  
L25_annotation <- read_csv('~/INDEPTH/run_031124/L25_final_annotation_032024.csv')


```

## Color palette for cell types

Define color palettes for different cell types. 

```{r}

L24_celltype_color <- c('DC' = '#377EB8', 'BCL6+ B Cell' = '#F781BF', 'CD4 T' = '#4DAF4A', 'CD8 T' = '#984EA3',
                    'M2' = '#F7C173', 'Endothelial' = '#A65628', 'M1' = '#00FFFF', 
                    'CD4 Treg' = '#BEBADA', 'Other' = 'gray', 'Myeloid' = '#E41A1C', 'BCL6- B Cell' = '#F6CEC1')


L25_celltype_color <- c('DC' = '#377EB8', 'BCL6+ B Cell' = '#F781BF', 'CD4 T' = '#4DAF4A', 'CD8 T' = '#984EA3',
                    'M2' = '#d24e01', 'Endothelial' = '#A65628', 'M1' = '#00FFFF', 
                    'CD4 Treg' = '#BEBADA', 'Other' = 'gray', 'Myeloid' = '#E41A1C', 'BCL6- B Cell' = '#F6CEC1')

```



## Load markers



```{r, eval = TRUE, warning=FALSE, message = FALSE}

L24_markers <- read_csv('~/INDEPTH/run_031124/extracted_info_no_gate/L24_dataScaleSize_no_gate.csv') %>% 
  select(cellLabel, Y_cent, X_cent, cellSize, DAPI, Pax5, CD20, BCL6, CD3, CD4, FoxP3, CD8, CD31, CD11c, CD68, CD163, CD11b)

L25_markers <- read_csv('~/INDEPTH/run_031124/extracted_info_no_gate/L25_dataScaleSize_no_gate.csv') %>% 
  select(cellLabel, Y_cent, X_cent, cellSize, DAPI, Pax5, CD20, BCL6, CD3, CD4, FoxP3, CD8, CD31, CD11c, CD68, CD163, CD11b)

```

## Process markers

Two steps were done:

1. Median nuclear signal scaling
2. Quantile scaling to scale the markers to be within $[0,1]$. 


```{r, eval = TRUE, warning=FALSE, message = FALSE}

tonsil_pheno_marker <- c('Pax5', 'CD20', 'BCL6', 'CD3', 'CD4', 'FoxP3', 'CD8', 'CD31', 'CD11c', 'CD68', 'CD163', 'CD11b')

L24_full <- L24_annotation %>% 
  select(cellLabel, Y_cent, X_cent, Annotation5) %>% 
  left_join(L24_markers, by = c('cellLabel')) %>% 
  drop_na()
  

L25_full <- L25_annotation %>% 
  select(cellLabel, Y_cent, X_cent, Annotation7) %>% 
  left_join(L25_markers, by = c('cellLabel')) %>% 
  drop_na()


L24_trans <- L24_full

rng <- colQuantiles(as.matrix(L24_trans[,9:20]), probs = c(0.001, 0.999))

expr <- t((t(as.matrix(L24_trans[,9:20]))-rng[,1]) / (rng[,2]-rng[,1]))

expr[expr < 0] <- 0

expr[expr > 1] <- 1

L24_trans[,9:20] <- expr

L25_trans <- L25_full

rng <- colQuantiles(as.matrix(L25_trans[,9:20]), probs = c(0.001, 0.999))

expr <- t((t(as.matrix(L25_trans[,9:20]))-rng[,1]) / (rng[,2]-rng[,1]))

expr[expr < 0] <- 0

expr[expr > 1] <- 1

L25_trans[,9:20] <- expr

L24_trans <- L24_trans %>% 
  rename('Annotation' = Annotation5)

L25_trans <- L25_trans %>% 
  rename('Annotation' = Annotation7)

L24_L25_df <- rbind(L24_trans, L25_trans)

```


# Figure plots

## Fig2 C


```{r, eval =TRUE, warning=FALSE,message=FALSE}

markers <- c('BCL6', 'CD11b', 'CD11c', 'CD163', 'CD20', 'CD3', 'CD31', 'CD4', 'CD68', 'CD8', 'FoxP3', 'Pax5')

plot_df <- L24_L25_df %>% 
  ungroup() %>% 
  #filter(!str_detect(coreName, 'Tonsil')) %>% 
  #filter(str_detect(coreName, 'Rochester')) %>% 
  dplyr::select(Annotation, all_of(markers), -DAPI)

mean_df <- plot_df %>% 
  pivot_longer(cols = -Annotation, names_to = 'marker', values_to = 'value') %>% 
  group_by(marker, Annotation) %>% 
  summarise(mu = mean(value))


pop_mean_df <- plot_df %>% 
  pivot_longer(cols = -Annotation, names_to = 'marker') %>% 
  group_by(marker) %>% 
  summarise(pop_mean = mean(value),
            pop_sd = sd(value))

mean_df <- mean_df %>% 
  ungroup() %>% 
  mutate(pop_mean = pop_mean_df$pop_mean[match(mean_df$marker, pop_mean_df$marker)],
         pop_sd = pop_mean_df$pop_sd[match(mean_df$marker, pop_mean_df$marker)]) %>% 
  mutate(z_new = (mu - pop_mean)/pop_sd)

heatmap_df <- mean_df %>% 
  dplyr::select(marker, z_new, Annotation) %>% 
  pivot_wider(names_from = 'marker', values_from = 'z_new')

heatmap_mat <- t(as.matrix(heatmap_df[,2:13]))

colnames(heatmap_mat) <- heatmap_df$Annotation

library(circlize)
col_fun = colorRamp2(c(-1, 0, 1), c('#4575b4', "white", '#d73027'))

bar_vec <- L24_L25_df %>% 
  #filter(!str_detect(coreName, 'Tonsil')) %>% 
  #filter(str_detect(coreName, 'Rochester')) %>% 
  group_by(Annotation) %>% 
  dplyr::count() %>% 
  mutate(log_n = log10(n))

column_ha <- HeatmapAnnotation(count = anno_barplot(bar_vec$n, border = FALSE, bar_width = 0.9,
                                                    gp = gpar(col = 'black', fill = rep(L24_celltype_color[sort(names(L24_celltype_color))],1)),
                                                    height = unit(3, 'cm')),
                               show_annotation_name = FALSE)

column_ha2 <- HeatmapAnnotation(celltype = sort(names(L24_celltype_color)),
                                col = list(celltype = L24_celltype_color), show_annotation_name = TRUE,
                                gp = gpar(col = 'black', lwd = 2),
                                annotation_legend_param = list(title = 'Cell Type'))

fig2_c <- Heatmap(heatmap_mat, cluster_rows = FALSE, cluster_columns  = FALSE, col = col_fun, clustering_method_columns = 'complete',
                   row_names_side = 'left', top_annotation = column_ha, column_names_gp = grid::gpar(fontsize = 12),
                   row_names_gp = grid::gpar(fontsize = 12), rect_gp = gpar(col = "black", lwd = 2), show_column_names = TRUE, name = 'Z Score',
                   heatmap_legend_param = list(border = 'black'))

draw(fig2_c)


```


